from typing import List, Literal, Tuple

from langchain.chains.summarize.refine_prompts import prompt_template

Query_Split_Prompt_1 = (
    '''
    你是资深金融研报分析专家，请按照以下步骤严谨拆解用户的复杂问题：

    ### 步骤1：问题类型识别
    - 宏观政策 | 行业比较 | 财务建模 | 估值分析 | 风险预警 | 事件驱动 | 数据追溯

    ### 步骤2：核心需求定位
    - 关键指标：明确用户关注的核心指标（如ROIC、β系数、现金流贴现等）
    - 时间维度：区分短期催化、长期趋势，务必识别具体时间点或区间
    - 分析层级：公司、行业或跨市场对比

    ### 步骤3：专业动作拆解
    - 数据溯源：数据来源（财报、监管文件、第三方数据库等）
    - 逻辑链验证：因果假设→驱动因子→验证路径
    - 交叉验证点：相关指标联动（如分析毛利率需同步验证营收结构与成本波动）

    ### 步骤4：隐含需求挖掘
    - 监管政策敏感度 | 黑天鹅事件预设 | 市场情绪修正

    ### 示例库（Few-Shot）：
    [用户query] 
    "如何解读宁德时代Q3毛利率逆势上升5pct的可持续性？"
    [拆解过程]
    1. 类型：财务建模 + 行业比较
    2. 核心指标：毛利率变动归因（价格、成本、产品结构）
    3. 专业动作：
       - 成本端：锂价环比、电解液成本曲线验证（SNE Research）
       - 收入端：高镍产品占比变化（公司公告P.23）
       - 可持续性测试：竞对亿纬锂能毛利率弹性对比与技术迭代周期
    4. 隐含需求：动力电池定价权转移风险

    [用户query]
    "美联储加息末期对港股科技板块的传导路径？"
    [拆解过程]
    1. 类型：宏观政策 + 跨市场分析
    2. 核心指标：无风险利率→估值模型切换→资金流动
    3. 专业动作：
       - 历史回测：2018年加息末期恒生科技指数波动率
       - 传导链：美债实际收益率→港股DCF分母端→北向资金托管数据
       - 对冲因子：人民币汇率期权隐含波动率
    4. 隐含需求：离岸市场流动性危机预案

    ### 当前任务：
    用户query：「{query}」
    请严格按上述步骤拆解，输出结构化JSON，字段名必须为 `sub_questions`，并标注数据验证优先级[★]。

    ---
    ### 输出格式要求：
    - 仅返回JSON，不要额外说明或文本
    - JSON示例如下，按示例格式填写拆解内容

    JSON：
    ```json
    {{
      "sub_questions": [
        /* 请在此处填入拆解的子问题，格式应遵循示例 */
      ]
    }}
    ```
    '''
)

Query_Split_Prompt_2 = (
    '''
    你是一位资深的金融研报阅读专家，擅长将复杂财经问题拆解成逻辑严谨、专业全面的子问题，以便后续逐步深入回答和结构化信息抽取。下面先给出两个拆解示例，再让你根据同样的思路进行拆解。

    ### 示例 1
    原问题：  
    “2023年5月，广发基金的基金经理张三卸任科技创新基金（代码001234），该基金在新能源行业布局较多。请分析这次人事变动对行业及市场的潜在影响，并提取相关关键词。”

    拆解输出（JSON 格式）：
    {
      "sub_questions": [
        "该事件的发生时间是哪一时点？",
        "本次变动涉及的主要机构和人物是谁？",
        "该基金所聚焦的行业领域有哪些特点？",
        "此次人事变动可能对新能源行业产生哪些影响？",
        "市场和投资者对该变动的短期和长期反应如何？",
        "相关的核心关键词有哪些？"
      ]
    }

    ### 示例 2
    原问题：  
    “某银行在2024 Q1 实现净利润同比增长 25%，主要得益于零售业务和财富管理业务的提振。请拆解问题并提取关注点，用于下一步深度分析。”

    拆解输出（JSON 格式）：
    {
      "sub_questions": [
        "该业绩披露的具体时间和报告期是什么？",
        "净利润同比增长的绝对数和基数分别是多少？",
        "零售业务和财富管理业务贡献了多少利润增量？",
        "驱动这些业务提升的核心因素有哪些？",
        "该增长对银行整体估值和风险偏好可能有何影响？",
        "需要跟踪的后续关键指标有哪些？"
      ]
    }

    ---

    ### 现在，请你按照上述示例，对以下原问题进行同样风格的拆解，并输出结构化 JSON（字段名必须为 `sub_questions`）：

    原问题：  
    “{query}”

    JSON：
    ```json
    {
      "sub_questions": [
        /* 请在此按照示例格式，填入你拆解出的子问题 */
      ]
    }
    ```

    '''
)
Query_Parsing_Prompt_1 = (
    '''
    # 系统背景
    你是一位资深的金融研报阅读专家，擅长从各类财经文本中快速、准确地抽取关键信息，并能结合上下文判断时间、机构、人物、行业等要素。请务必仅输出**严格格式化的 JSON**，不要包含多余的注释或解释文字。

    # 抽取字段
    1. 时间：如 “今日”、“本周”、“去年年报” 等  
    2. 日期区间：当时间指向具体范围时，返回 “起始日 至 结束日”，否则返回 “无”  
    3. 主体机构/公司：报告发起或核心分析机构，**必须是具体名称**，否则填 “无”  
    4. 对象机构/公司：报告的研究对象或协作方，**同上**  
    5. 行业：文本所涉行业领域，如“医药”、“半导体”  
    6. 人名：作者或主要报告撰写人，若主体机构为 “无”，则该字段也填 “无”  
    7. 基金代码：如“001234”或“JY1234”  
    8. 基金产品名称：如“天弘余额宝货币基金”  
    9. 主题：一句话概括核心分析议题  
    10. 关键词：从剩余内容中抽取核心术语或实体，不包含已由其他字段覆盖的概念  

    # 时间处理细则
    - **明确日期词**（“今日”“昨日”“本周”“上月” 等）：  
      - “时间” 保留该词；  
      - “日期区间” 以系统当前真实日期推算并返回区间。  
    - **模糊词**（“近期”“最新”）：时间字段保留原词，区间填 “无”。  
    - **历史/前瞻**（“去年年报”“未来三个月” 等）：时间字段原样返回，区间填 “无”。  
    - 未识别到任何时间要素，则 “时间”/“日期区间” 均 “无”。
    - 系统自动以“当前系统运行时间”为基准处理模糊时间表述：
    - “上周” → 当前日期前7日至前1日（如：系统当前为2025-07-14，则上周为2025-07-07至2025-07-13）
    - “最近” → 默认向前滚动90天
    - 所有季度信息自动识别所在年份及起止日期

    # 机构与人名约束
    - **机构名称**：只能填具体机构（券商、上市公司、智库等），不可填泛称（如“卖方”“各家券商”）。  
    - **人名**：仅当 **主体机构/公司** 非 “无” 且文本明确指出作者/分析师时返回其姓名，否则 “无”。

    # 关键词约束
    - 只提取未被其他字段覆盖的核心术语或实体。  
    - 国家、地区、知名人物若未归入其他字段，必须包含在关键词中。

    # 示例（当前系统日期：2025‑07‑09）
    ### 示例 1  
    Q：最近 AI 概念股表现如何？ 
    ```json
    {{
      "时间": "最近一周",
      "日期区间": "2025-07-02至2025-07-09",
      "主体机构/公司": "无",
      "对象机构/公司": "无",
      "行业": "人工智能",
      "人名": "无",
      "基金代码": "无",
      "基金产品名称": "无",
      "主题": "AI 概念股近期表现",
      "关键词": ["AI 概念股", "涨跌幅", "市场情绪"]
    }}

    ### 示例 2
    Q：帮我看一下本季度苹果公司营收增长的主要原因。
    ```json
    {{
      "时间": "本季度",
      "日期区间": "2025-04-01至2025-06-30",
      "主体机构/公司": "苹果公司",
      "对象机构/公司": "无",
      "行业": "消费电子",
      "人名": "无",
      "基金代码": "无",
      "基金产品名称": "无",
      "主题": "苹果公司本季度营收增长驱动因素",
      "关键词": ["iPhone 出货量", "服务收入", "大中华区表现"]
    }}


    ### 示例 3
    Q：请分析上周新能源汽车行业的研发投资趋势。
    ```json
    {{
      "时间": "上周",
      "日期区间": "2025-07-02至2025-07-08",
      "主体机构/公司": "无",
      "对象机构/公司": "无",
      "行业": "新能源汽车",
      "人名": "无",
      "基金代码": "无",
      "基金产品名称": "无",
      "主题": "新能源汽车行业上周研发投资趋势",
      "关键词": ["研发投入", "电池技术", "自动驾驶"]
    }}
    ## 参照以上示例子，处理当前任务
    解析query：「{query}」
    输出要求：
    - 严格遵循JSON格式
    - 未识别字段返回「无」
    - 禁止新增任何解释性文本

    '''

)

Query_Parsing_Prompt_2 = ('''
    example1_response = json.dumps(
        {{
            "date": "2025年二季度",
            "date_range": "2025-04-01至2025-06-30",
            "institution": "无",
            "target_entity": "宁德时代",
            "industry": "动力电池",
            "authors": "无",
            "fund_codes": "无",
            "fund_names": "无",
            "topic": "宁德时代2025Q2毛利率逆势提升的原因分析及持续性评估",
            "keywords": "原材料成本,技术溢价,竞争格局",
            "report_type": "公司点评"
        }},
        ensure_ascii=False
    )

    example2_response = json.dumps(
        {{
            "date": "最近三个月",
            "date_range": "2025-04-09至2025-07-09",
            "institution": "中金公司/摩根士丹利",
            "target_entity": "港股互联网板块",
            "industry": "科技",
            "authors": "彭文生/邢自强",
            "fund_codes": "无",
            "fund_names": "无",
            "topic": "美联储降息预期对港股科技股估值修复路径的影响",
            "keywords": "无风险利率,DCF模型,流动性改善",
            "report_type": "宏观研究"
        }},
        ensure_ascii=False
    )

    example3_response = json.dumps(
        {{
            "date": "2024年度",
            "date_range": "无",
            "institution": "无",
            "target_entity": "药明康德/药明生物",
            "industry": "CXO",
            "authors": "无",
            "fund_codes": "无",
            "fund_names": "无",
            "topic": "美国生物安全法案对国内CXO企业2024年业绩影响的量化分析",
            "keywords": "地缘政治风险,订单可见度,产能利用率",
            "report_type": "专题研究"  
        }},
        ensure_ascii=False
    )

    example4_response = json.dumps(
        {{
            "date": "本月",
            "date_range": "2025-07-01至2025-07-09",
            "institution": "高盛/摩根大通",
            "target_entity": "人民币汇率",
            "industry": "外汇",
            "authors": "无",
            "fund_codes": "无",
            "fund_names": "无",
            "topic": "主要投行对近期人民币快速升值原因及下半年走势的最新观点",
            "keywords": "中美利差,跨境资本流动,央行干预",
            "report_type": "宏观研究"
        }},
        ensure_ascii=False
    )

    # 强化系统提示词逻辑
    system_prompt = f"""
    # 金融研报智能解析系统
    ## 核心任务
    精准解构用户query，提取11维度金融元数据

    ## 关键改进
    1. 时间智能锚定：基于当前日期动态校准时间窗口
    2. 实体关系拓扑：构建机构-人物-标的关联网络
    3. 行业术语标准化：自动映射至GICS三级分类

    ## 专业处理规则
    ### 时间解析引擎
    | 用户表述         | 处理逻辑                                      | 示例输出（以当前系统时间为2025-07-14为例子）     |
    |------------------|-----------------------------------------------|--------------------------------------------|
    | "上周"           | 前一个自然周（上周一至上周日）               | 2025-07-07至2025-07-13                     |
    | "前两周"         | 前两个完整自然周（上上周一至上上周日）       | 2025-06-30至2025-07-06                     |
    | "最近两周"       | 当前日期往前滚动14天                         | 2025-06-30至2025-07-14                     |
    | "最近"           | 默认近3个月                                  | 2025-04-14至2025-07-14                     |
    | "上半年"         | 当年1月1日-6月30日                            | 2025-01-01至2025-06-30                     |
    | "Q3"             | 当前季度起止（季度自动识别）                 | 2025-07-01至2025-09-30                     |
    | "降息周期"       | 标记政策阶段                                 | 货币政策转向期      

    ## 动态时间窗口逻辑
    系统自动以“当前系统运行时间”为基准处理模糊时间表述，以下是以2025-07-14为例子：
    - “上周” → 上一完整自然周（例：2025-07-07至2025-07-13）
    - “前两周” → 上上周的自然周起止（例：2025-06-30至2025-07-06）
    - “最近两周” → 当前日期向前滚动14天（例：2025-06-30至2025-07-14）
    - “最近” → 默认最近三个月（90天）
    - 所有季度信息自动识别所在年份及起止日期

    ### 机构识别矩阵
    ```mermaid
    graph LR
    A[原始表述] --> B{{是否具名？}}
    B -->|是| C[标准化简称]
    B -->|“头部券商”| D[映射TOP5机构]
    B -->|“外资行”| E[高盛/摩根士丹利/瑞银]
    B -->|无明确指向| F[标记“无”]
    ```

    # 报告类型
    结合文本内容判断报告属于以下哪一类：“宏观研究”“行业研究”“公司点评”“策略研究”“基金研究”“专题研究”“其他”

    ### 关键词过滤机制
    保留三类核心术语：
    1. 金融指标：ROIC/WACC/EV/EBITDA
    2. 政策术语：MPA考核/注册制/YCC政策
    3. 风险因子：信用利差/波动率曲面/流动性溢价

    ## 自然语言示例库
    Q1: 宁德时代二季度毛利率为什么能逆势提升？这种趋势能维持吗？
    → {{example1_response}}

    Q2: 想了解中金彭文生和摩根士丹利邢自强最近三个月对港股互联网板块的看法，特别是美联储可能降息的影响
    → {{example2_response}}

    Q3: 美国那个生物安全法案对药明康德去年业绩实际造成了多大冲击？
    → {{example3_response}}

    Q4: 高盛和大摩最近对人民币突然走强有什么新解读？下半年怎么看？
    → {{example4_response}}

    ## 当前任务
    解析query：「{query}」
    输出要求：
    - 严格遵循JSON格式
    - 未识别字段返回「无」
    - 日期区间格式：YYYY-MM-DD至YYYY-MM-DD
    - 禁止任何解释性文本
    '''
                          )

chunk_extract_prompt = ('''
    你是一个专注于结构化信息抽取的金融 NLP 系统，任务是从以下**完整研报正文**中提取 10 项关键信息。你必须根据文本内容，进行精准、全面、结构化地分析，输出**严格标准化的 JSON 格式**结果，不允许有任何说明性文本或 Markdown 包裹。

    ---

    **需要提取的字段说明如下：**

    1. **"date_range"**：
       - 格式如“2025-06-01至2025-06-30”
       - 若出现“上周”“过去一个月”“2025年Q2”等表达，请根据今天报告日期推算合理起止时间
       - 无法确定则填“无”

    2. **"target_entity"**：
       - 指报告分析的对象，可以是具体公司、行业、子行业、板块等
       - 示例：宁德时代、白酒行业、港股互联网、科创板公司
       - 多个请用中文逗号连接
       - 注意区分主语与背景说明，泛指或宏观语境不算分析对象

    3. **"industry"**：
       - 提取主要分析所属的行业分类，优先使用中信一级或二级行业词汇，如“新能源”“食品饮料”“半导体设备”
       - 若为跨行业、多板块，可列举主要领域，用逗号隔开

    4. **"authors"**：
       - 提取文章的作者，身份可以是分析师、研究员等
       - 示例：李春、赵一鸣、黄志强、David Solomon
       - 人名的上下文要有明确提示词，如研究员，分析师，分析员，否则该人名不被考虑
       - 人名次序按照职位排列，如所长>组长,高级研究员>研究员>副研究员，高级分析师>分析师
       - 不提及人名则填“无”，职位泛称（如“某研究员”）不算有效人名

    5. **"fund_codes"**：
       - 正文中如出现类似“161005.OF”“000001.SZ”等格式的基金/股票代码，填写
       - 无则填“无”

    6. **"fund_names"**：
       - 若报告中提及如“华夏成长混合A”“易方达科技创新”，请填写
       - 无则填“无”

    7. **"topic"**：
       - 提炼为简洁、直观的议题短语
       - 示例：中报业绩解读、产业链供需格局变化、流动性宽松预期、估值修复逻辑

    8. **"keywords"**：
       - 提取 5~10 个高频术语、分析要点、核心指标或关键判断
       - 示例：毛利率、融资成本、ROE、政策催化、出口数据、市场份额
       - 使用中文逗号分隔
    ---

    **请从以下正文中提取上述字段：**

    ---------------------
    {full_report_text}
    ---------------------

    **请严格以以下格式返回**：
    （注意：无 Markdown、无解释说明）

    {{
      "date_range": "",
      "target_entity": "",
      "industry": "",
      "authors": "",
      "fund_codes": "",
      "fund_names": "",
      "topic": "",
      "keywords": ""
    }}
''')

chunk_extract_prompt_new = ('''
    你是一个专注于结构化信息抽取的金融 NLP 系统，任务是从以下**完整研报正文**中提取 10 项关键信息。你必须根据文本内容，进行精准、全面、结构化地分析，输出**严格标准化的 JSON 格式**结果，不允许有任何说明性文本或 Markdown 包裹。

    ---

    **需要提取的字段说明如下：**

1. **"date"**：
   - 指报告发布日期,如20250505-Q1代表2025年5月5号第一季度；1Q25:2025年第一季度；20250425:2025年4月25号；250425：2025年4月25号；4月：2025年4月
   - 无法确定则填“无”

2. **"institution"**：
   - 指发布该报告的机构名称，如“中信证券”“华泰研究所”“国投期货”“东兴证券”
   - 多个机构请用中文逗号分隔
   - 无则填“无”

3. **"title"**：
   - 提取报告标题，若无显式标题可概括正文核心内容
   - 示例：需求修复助力成长——2025年中报展望
   - 无则填“无”

4. **"report_type"**：
   - 提取报告类型，如“行业研究”“策略研究”“宏观研究”“公司分析”“公司点评报告”“电子行业周报”“晨会纪要”等
   - 无法识别则填“无”

5. **"date_range"**：
   - 格式如“2025-06-01至2025-06-30”
   - 若出现“上周”“过去一个月”“2025年Q2”等表达，请根据报告日期推算合理起止时间
   - 无法确定则填“无”

6. **"target_entity"**：
   - 指报告分析的对象，可以是具体公司、行业、子行业、板块等
   - 示例：宁德时代、白酒行业、港股互联网、科创板公司
   - 多个请用中文逗号连接
   - 泛指或宏观背景不算分析对象

7. **"industry"**：
   - 提取主要分析所属的行业分类，优先使用中信一级或二级行业词汇，如“新能源”“食品饮料”“半导体设备”
   - 多行业并列时请用中文逗号隔开

8. **"authors"**：
   - 提取文章的作者，身份可为研究员、分析师等
   - 示例：李春、赵一鸣、黄志强、David Solomon
   - 仅提到职位（如“某分析师”）或没有上下文身份提示的，不算有效人名
   - 按照职位级别排序，如所长 > 高级分析师 > 分析师 > 助理

9. **"fund_codes"**：
   - 标题和正文中如出现“161005.OF”“000001.SZ”“600809”等基金/股票代码，请填写
   - 多个请用中文逗号分隔
   - 无则填“无”

10. **"fund_names"**：
    - 如标题或正文提及“华夏成长混合A”“易方达科技创新”“烽火通信”“贵州茅台”等请填写
    - 多个请用中文逗号分隔
    - 无则填“无”

11. **"topic"**：
    - 提炼为简洁、直观的议题短语
    - 示例：中报业绩解读、流动性预期、行业政策拐点
    - 无则填“无”

12. **"keywords"**：
    - 根据篇幅和文章结构提取高频术语、分析要点、核心指标或关键判断。
    - 正文字数3000字一下关键词控制在10个以内，3000字以上控制在15~25个以内
    - 示例：毛利率、融资成本、ROE、政策催化、出口数据、市场份额
    - 中文逗号分隔
    ---

    **请从以下正文中提取上述字段：**

    ---------------------
    {full_report_text}
    ---------------------

    **请一定要严格用以下格式返回 （无 Markdown、无解释说明）**

    {{
      "date": "",
      "institution": "",
      "title": "",
      "report_type": "",
      "date_range": "",
      "target_entity": "",
      "industry": "",
      "authors": "",
      "fund_codes": "",
      "fund_names": "",
      "topic": "",
      "keywords": ""
    }}

''')

# 最终构造的 where 查询语句（示例）
where = {
    "$and": [
        # chunk_id 精确匹配或列表匹配
        {"chunk_id": {"$in": ["abc123_0", "abc123_1"]}},
        # file_id 排除某个文件
        {"file_id": {"$ne": "def456"}},

        # chunk_text 包含某些关键词
        {"chunk_text": {"$contains": "美债"}},
        # chunk_text 不包含特定词
        {"chunk_text": {"$not_contains": "违约"}},

        # 时间范围筛选（日期为字符串形式）
        {"时间": {"$gte": "2025-04-01"}},
        {"时间": {"$lte": "2025-06-30"}},

        # 主体机构（精确匹配多个）
        {"主体机构/公司": {"$in": ["国金证券", "华泰证券"]}},

        # 标题包含关键词
        {"标题": {"$contains": "化债"}},

        # 报告类型正向筛选
        {"报告类型": {"$eq": "宏观研究"}},
        # 报告类型负向筛选
        {"报告类型": {"$ne": "基金研究"}},

        # 日期区间包含季度关键词
        {"日期区间": {"$contains": "2025-04"}},

        # 对象机构包含“美联储”或“美国”
        {"对象机构或公司": {"$contains": "美联储"}},

        # 行业匹配某几个领域
        {"行业": {"$in": ["宏观经济", "金融"]}},

        # 作者正向精确匹配
        {"作者": {"$eq": "宋雪涛"}},

        # 基金代码排除“无”
        {"基金代码": {"$ne": "无"}},

        # 基金产品名称模糊匹配
        {"基金产品名称": {"$contains": "嘉实"}},
        {"基金产品名称": {"$not_contains": "中欧"}},

        # 主题包含关键词
        {"主题": {"$contains": "信用风险"}},

        # 关键词字段：包含关键词集合（注意必须是数组）
        {"关键词": {"$in": ["美债", "美元", "利息支出"]}},
        # 关键词字段：排除某些词
        {"关键词": {"$nin": ["去美元化", "违约"]}},
    ]
}


def entity_extract_prompt(full_text: str) -> str:
    prompt = f"""
    你是一个金融研报分析专家，任务是从给定的金融研报文本中提取实体。实体需明确出现在文本中，覆盖金融领域的多维度类型。输出为 JSON 格式的字符串列表，包含去重后的实体。

    **要求**：
    1. **实体类型**：
       - 提取以下类型的实体：
         - **宏观经济**：如通胀、GDP、经济增长、失业率、财政政策、货币政策
         - **金融市场**：如美元、美股、A股、港股、黄金、原油、债券、期货、汇率、利率、上证指数、恒生指数
         - **行业**：如新能源、房地产、科技、能源、消费品、医药、半导体
         - **公司**：具体公司名称（如“特斯拉”“苹果”）
         - **机构**：如美联储、中国央行、欧洲央行
         - **地缘政治**：如贸易战、关税、制裁、中美关系
       - 仅提取明确出现在文本中的实体，避免推测或生成不存在的实体。
       - 忽略抽象概念（如“流动性风险”“市场情绪”），仅保留适合作为关系节点的实体。

    2. **输出格式**：
       - 返回 JSON 格式的字符串列表，例如 `["美元", "美股", "特斯拉"]`。
       - 确保输出为有效 JSON，去重后排序。

    3. **处理长文本**：
       - 文本可能较长（约6000字），分段分析每段中的实体，确保不遗漏。

    **示例**：

    1. **输入文本**：
       “2025年美联储加息推高美债收益率，美元因此走强。特斯拉因高利率成本上升，盈利预期下调。新能源行业受政策支持而增长。”
       **输出**：
       ["美联储", "美债", "美元", "特斯拉", "利率", "新能源", "政策"]

    2. **输入文本**：
       “全球经济衰退风险上升，引发避险情绪，黄金价格因此上涨。美元走强对黄金构成压制。原油价格因贸易战紧张而波动。”
       **输出**：
       ["全球经济", "黄金", "美元", "原油", "贸易战"]

    3. **输入文本**：
       “中国央行降准释放流动性，提振A股市场。人民币因流动性宽松承压贬值。半导体行业受政策支持而增长。”
       **输出**：
       ["中国央行", "A股", "人民币", "半导体", "政策"]

    4. **输入文本**：
       “贸易战升级导致关税提高，推高企业成本，苹果公司盈利预期下降。上证指数因外部压力表现低迷。”
       **输出**：
       ["贸易战", "关税", "苹果", "上证指数"]

    **任务**：
    根据以下文本，提取实体，返回 JSON 格式的字符串列表。

    **文本**：
    {full_text}

    输出格式如下：：
    ["entity_1","entity_2"  ... ]

    **注意**
    请尽可能保证不小于五条的返回值
    """
    return prompt


def relation_extract_prompt(full_text: str, entities: List[str]) -> str:
    """
    生成 Few-Shot Prompt 用于提取金融研报中的实体关系
    参数：
        full_text: 合并后的 chunk_text（整篇研报或部分文本）
        entities: 实体列表（从 target_entity 和 keywords 提取）
    返回：
        格式化的 Prompt 字符串
    """
    prompt = f"""
    你是一个金融研报分析专家，任务是从给定的金融研报文本中提取实体之间的因果或影响关系。关系需在文本中有明确或合理的依据（如“导致”“可能导致”“推动”“影响”等表述）。输出为 JSON 格式的列表，每个关系格式为：{{"entity1": "实体1", "relation": "关系", "entity2": "实体2"}}。

    **要求**：
    1. **实体类型**：
       - 提取的 `entity1` 和 `entity2` 必须来自提供的实体列表，允许近似匹配（如“弱美元”匹配“美元”，“美债收益率”匹配“美债”）。
       - 实体类型包括但不限于：
         - **宏观经济**：通胀、GDP、经济增长、失业率、财政政策、货币政策
         - **金融市场**：美元、美股、A股、黄金、原油、债券、期货、汇率、利率
         - **行业**：新能源汽车、房地产、科技、能源、消费品
         - **公司**：具体公司名称（如“特斯拉”“苹果”）
         - **机构**：美联储、中国央行、欧洲央行
         - **地缘政治**：贸易战、关税、制裁
         - **其他**：避险情绪、流动性、信用风险、市场情绪
       - 如果文本中出现未在实体列表中的实体，可忽略，但优先匹配列表中的实体。

    2. **关系提取**：
       - 提取文本中明确或合理推断的因果或影响关系（如“导致”“推高”“压制”“提振”“构成压力”“可能导致”“预计影响”）。
       - 关系描述使用金融领域常见术语，示例包括：
         - 因果：导致、引发、推动、促进、抑制、压制
         - 影响：提振、承压、构成压力、支撑、削弱
         - 相关性：相关性增强、联动、同步波动
       - 避免提取无依据的推测关系。

    3. **处理长文本**：
       - 研报文本可能较长（约6000字），分段分析每段中的因果关系，确保不遗漏。
       - 优先提取与实体列表相关的关系，忽略无关内容。

    4. **输出格式**：
       - 返回 JSON 格式的列表，格式为 `[{{"entity1": "xxx", "relation": "xxx", "entity2": "xxx"}}, ...]`。
       - 如果没有符合条件的关系，返回空列表 `[]`。
       - 确保 JSON 格式有效。

    **示例**：

    1. **输入文本**：
       “2025年美联储降息预期减弱，推高美债收益率，美元因此走强。美股因高利率环境承压下跌。”
       **输入实体列表**：美债, 美元, 美股, 美联储, 美债收益率
       **输出**：
       [
           {{"entity1": "美联储", "relation": "推高", "entity2": "美债收益率"}},
           {{"entity1": "美债收益率", "relation": "导致", "entity2": "美元"}},
           {{"entity1": "美债收益率", "relation": "构成压力", "entity2": "美股"}}
       ]

    2. **输入文本**：
       “全球经济衰退风险上升，引发避险情绪，黄金价格因此上涨。美元走强对黄金构成压制。”
       **输入实体列表**：全球经济, 避险情绪, 黄金, 美元
       **输出**：
       [
           {{"entity1": "全球经济", "relation": "引发", "entity2": "避险情绪"}},
           {{"entity1": "避险情绪", "relation": "导致", "entity2": "黄金"}},
           {{"entity1": "美元", "relation": "压制", "entity2": "黄金"}}
       ]

    3. **输入文本**：
       “中国央行降准释放流动性，提振A股市场情绪。人民币因流动性宽松承压贬值。”
       **输入实体列表**：中国央行, 流动性, A股, 人民币
       **输出**：
       [
           {{"entity1": "中国央行", "relation": "释放", "entity2": "流动性"}},
           {{"entity1": "流动性", "relation": "提振", "entity2": "A股"}},
           {{"entity1": "流动性", "relation": "承压", "entity2": "人民币"}}
       ]

    **任务**：
    根据以下文本和实体列表，提取实体之间的因果或影响关系，返回 JSON 格式的列表。

    **文本**：
    {full_text}

    **实体列表**：
    {', '.join(entities)}

    输出格式如下：
    [
  {{"entity1": "xxx", "relation": "xxx", "entity2": "xxx"}},
  ...
    ]
    **注意**
    请尽可能保证不小于五条的返回值
    """
    return prompt


from llama_index.core.prompts import PromptTemplate

# 用于三元实体关系提取的prompt
EXTRACTOR_PROMPT = PromptTemplate("""
你是一位金融领域知识图谱专家，你的任务是**高度概括**并从给定的金融研报文本中，
提取出**最核心的、不超过 {max_triplets_per_chunk} 个**结构化知识三元组。

# 提取规则
1.  **聚焦核心**: 不要提取琐碎的、描述性的事实。你的目标是找到能够连接关键实体、揭示主要趋势或因果关系的核心信息。例如，优先提取 (公司A, 收购, 公司B) 而不是 (报告, 包含, 图表3)。
2.  **高度概括**: 如果多个句子描述同一核心事件，请尝试将其概括为一个三元组。例如，如果文本说“A公司宣布计划收购B公司，并已提交文件”，应提取 `(A公司, 计划收购, B公司)`，而不是多个细节。
若文本中出现某个实体的缩写、简称、别称、俗称（如“港交所”），同时存在其全称（如“香港交易所”），则统一保留全称（“香港交易所”），并忽略缩写或别称的单独输出。若仅出现缩写或别称，则通过常见知识推断并补充其标准全称，并以全称作为最终输出。
3.  **严格数量限制**: **这是一个硬性要求**。你返回的三元组总数**绝对不能超过 {max_triplets_per_chunk} 个**。如果文本中有很多信息，请只选择最重要的返回。
4.  **输出格式**: 将所有提取的三元组格式化为一个JSON列表。每个三元组是一个包含 "subject", "predicate", "object" 键的字典。如果文本中没有可提取的核心三元组，请返回一个空列表 `[]`。

# 示例文本与输出 (max_triplets_per_chunk=2)
-------
文本:
"事件：2025 年4 月新增人民币贷款 2800 亿，市场预期为 3500 亿，同比少增。
国盛证券在最新的报告中分析并认为，这主要是由于实体经济信贷需求季节性回落所致。"
-------
输出:
[
  {"subject": "4月新增人民币贷款", "predicate": "低于", "object": "市场预期"},
  {"subject": "实体经济信贷需求季节性回落", "predicate": "是主要原因", "object": "4月新增人民币贷款减少"}
]

# 任务开始
根据以上规则，从下面的文本中提取知识三元组。
-------
文本:
{text}
-------
输出:
"""
)

FINANCE_ENTITIES = Literal[
    "组织",
    "公司",
    "经济数据",
    "指标",
    "政策",
    "事件",
    "时间",
    "金融概念",
    "券商"
]

FINANCE_RELATIONS = Literal[
    "影响",
    "导致",
    "是",
    "增加",
    "减少",
    "低于",
    "高于",
    "认为",
    "发布于",
    "担任",
]

FINANCE_VALIDATION_SCHEMA = {
    # 组织/公司 可以是许多行动的主体
    "组织": [
        "认为",
        "发布于",
        "影响",
        "导致",
        "担任",
    ],
    "公司": [
        "认为",
        "发布于",
        "影响",
        "导致",
        "担任",
    ],

    # 经济数据/指标 通常是比较和描述的对象
    "经济数据": [
        "是",
        "增加",
        "减少",
        "低于",
        "高于",
        "影响",
        "导致",
    ],
    "指标": [
        "是",
        "增加",
        "减少",
        "低于",
        "高于",
        "影响",
        "导致",
    ],

    # 政策/事件 是典型的因果关系主体
    "政策": [
        "影响",
        "导致",
        "发布于",
    ],
    "事件": [
        "影响",
        "导致",
        "发布于",
    ],

    # 日期/时间 通常作为关系的客体，
    # 但有时也可以是主体（例如 "2023年发布于...")
    "日期": [
        "发布于",
    ],
    "时间": [
        "发布于",
    ],

    # 金融概念 可以是更抽象的因果关系主体
    "金融概念": [
        "影响",
        "导致",
        "是...的核心驱动",
        "是",
    ],
}

CYPHER_PROMPT = PromptTemplate("""
你是一个专用于代码生成的AI模型，被设定为**Cypher查询生成引擎**。你的**唯一**任务是严格根据给定的Schema和用户问题，生成一段可直接执行的Cypher查询代码。**禁止**进行任何形式的对话、解释或提问。

# 任务描述

你的思考过程应该是：
1.  **理解用户问题的真实意图**，提取出核心的实体和关系概念。
2.  在`图数据库Schema`中，寻找与用户意图**语义最相近**的元素。用户的用词可能与Schema中的名称不完全一致（例如，用户问“CEO”，但Schema中是“manager”）。
3.  使用你找到的最匹配的Schema元素，构建一个精确的Cypher查询。

# 核心规则与约束 (必须严格遵守，否则视为失败)

1.  **Schema遵从性与意图理解**: 
    *   **如果用户的用词在Schema中不存在，不要立即放弃！** 你的首要任务是寻找语义上最接近的替代项。
    *   **[最终退路]** 如果在尽力理解和寻找后，你确信Schema中没有任何与用户问题相关的元素，**此时才能返回一个完全为空的字符串 `""`**。绝对禁止返回一个宽泛的、不相关的查询（如 `MATCH (n) RETURN n`）。
2.  **实体提取与精确匹配**: 必须在`WHERE`子句或`MATCH`的属性中，使用从用户问题中提取出的、具体的实体名进行精确匹配。**绝对禁止在最终的Cypher代码中出现`{query_str}`这个占位符字符串。**
3.  **语法精确性**: 生成的必须是单一、完整且语法无误的Cypher查询语句。
4.  **反引号（`）的使用**: 如果任何Schema元素包含**空格**或**特殊字符**，**必须**使用反引号（` `）包裹。
5.  **返回内容**: 
    *   `RETURN`子句应返回问题所直接询问的信息。
    *   **[核心要求]** 在返回主要信息的同时，**必须额外返回被查询到的主要目标实体的 `triplet_source_id` 属性**。
    *   对于聚合查询（如 `count()`），则无需返回 `triplet_source_id`。
6.  **输出格式 (绝对强制)**: 
    *   **你的唯一输出必须是纯粹的Cypher代码，或者是一个完全为空的字符串 `""`。**
    *   **绝对禁止**包含任何解释、注释、占位符或任何形式的自然语言。

# 图数据库Schema

{schema}

# 示例 (Few-shot Learning)

---
# [示例1: 多跳查询]
**问题**: "在港交所上市的虚拟资产现货ETF，规模有多大？"
**Cypher查询**:
MATCH (:entity {name: '港交所'})-[:`上市`]->(p:entity)
MATCH (p)-[:`规模`]->(s:entity)
RETURN s.name, p.triplet_source_id

---
# [示例2: 智能匹配/同义词查询 ]
**问题**: "告诉我Apple公司的CEO是谁？"
**Cypher查询**:
MATCH (:entity {name: 'Apple'})-[:`manager`]->(p:entity)
RETURN p.name, p.triplet_source_id

---
# [示例3: 单跳查询]
**问题**: "告诉我'胜利证券'这家公司的所有一级子公司。"
**Cypher查询**:
MATCH (p:entity {name: '胜利证券'})-[:`一级子公司`]->(c:entity) RETURN c.name, c.triplet_source_id

---
# [示例4: 聚合查询]
**问题**: "2023年注册成立的公司有多少家？"
**Cypher查询**:
MATCH (c:entity) WHERE c.founding_year = 2023 RETURN count(c)

---

# 用户问题

**问题**: "{question}"
**Cypher查询**:

""")

CUSTOM_QA_TEMPLATE = PromptTemplate(
    """你是一个问答机器人。请仔细阅读下面提供的多个上下文信息块，并利用它们来回答问题。每个上下文信息块都以'file_name:'开头，指明了该信息的来源文档。
    上下文信息如下:\n
    ---------------------
    {context_str}\n
    ---------------------
    **你的任务:**\n
    1. 只根据上面提供的上下文信息来回答问题，不要使用任何先验知识。
    2. 你的回答必须是中文。
    3. **【极其重要】** 对于你回答中的每一句话或每一个事实，都必须在句末用方括号[]标注出它所依据的'file_name'。
    4. 如果一句话综合了多个来源的信息，请列出所有相关的'file_name'，例如：[文件A.md, 文件B.md]
    5. 如果上下文信息不足以回答问题，请直接说“根据提供的资料，我无法回答这个问题。
    **问题:** {query_str}
    **回答:** """
)

CUSTOM_REFINE_TEMPLATE = PromptTemplate(
    """你是一个问答机器人。你的任务是根据下面提供的“新的上下文信息”，来完善一个“已有的回答”。每个上下文信息块都以'file_name:'开头，指明了该信息的来源文档
    **已有的回答:**
    {existing_answer}
    **新的上下文信息:**
    ---------------------
    {context_msg}\n"
    ---------------------
    **你的任务:**\n"
    1. 我们有一个可能不完整的“已有的回答”。请用“新的上下文信息”来对它进行补充、修正或完善。
    2. **如果“新的上下文信息”没有提供任何有用的新内容，请直接返回“已有的回答”，不要做任何改动。**
    3. **【极其重要】** 如果你从“新的上下文信息”中提取了新内容加入了回答，你必须在新增或修改的句末，用方括号[]标注出新内容所依据的'file_name'。
    4. 在完善答案时，**必须保留“已有的回答”中已经存在的来源标注**，不要删除或修改它们。
    **完善后的回答:** """
)
